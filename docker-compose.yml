version: '3.8'

services:
  # Main development sandbox for Claude Code
  via-sandbox:
    build:
      context: .
      dockerfile: docker/Dockerfile.sandbox
    container_name: via-dev
    image: via-sandbox:latest
    volumes:
      # Mount project directory
      - .:/workspace
      # Preserve node_modules in container
      - /workspace/node_modules
    working_dir: /workspace
    environment:
      - NODE_ENV=development
      - CI=false
      - SANDBOX=true
    # Security: drop all capabilities
    cap_drop:
      - ALL
    # Security: no new privileges
    security_opt:
      - no-new-privileges
    # Resource limits
    mem_limit: 2g
    cpus: 2
    pids_limit: 100
    # Network
    networks:
      - via-network
    # Keep container running
    stdin_open: true
    tty: true
    command: /bin/sh

  # Secure sandbox (read-only, no network)
  via-sandbox-secure:
    build:
      context: .
      dockerfile: docker/Dockerfile.sandbox
    container_name: via-dev-secure
    image: via-sandbox:latest
    volumes:
      # Read-only mount
      - .:/workspace:ro
      - /workspace/node_modules
    working_dir: /workspace
    environment:
      - NODE_ENV=production
      - CI=true
      - SANDBOX=true
    # Read-only filesystem
    read_only: true
    # Writable /tmp
    tmpfs:
      - /tmp
    # No network access
    network_mode: none
    # Security
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges
    # Resource limits
    mem_limit: 1g
    cpus: 1
    pids_limit: 50
    stdin_open: true
    tty: true
    command: /bin/sh

  # Development server (optional, for testing built package)
  via-dev-server:
    build:
      context: .
      dockerfile: docker/Dockerfile.sandbox
    container_name: via-server
    image: via-sandbox:latest
    volumes:
      - .:/workspace
      - /workspace/node_modules
    working_dir: /workspace
    environment:
      - NODE_ENV=development
    ports:
      - "3000:3000"
      - "5173:5173"
    networks:
      - via-network
    command: sh -c "pnpm dev"

  # Test runner (runs tests in isolation)
  via-test:
    build:
      context: .
      dockerfile: docker/Dockerfile.sandbox
    container_name: via-test
    image: via-sandbox:latest
    volumes:
      - .:/workspace
      - /workspace/node_modules
    working_dir: /workspace
    environment:
      - NODE_ENV=test
      - CI=true
    networks:
      - via-network
    command: sh -c "pnpm test"

  # CI runner (simulates GitHub Actions locally)
  via-ci:
    build:
      context: .
      dockerfile: docker/Dockerfile.sandbox
    container_name: via-ci
    image: via-sandbox:latest
    volumes:
      - .:/workspace
      - /workspace/node_modules
    working_dir: /workspace
    environment:
      - NODE_ENV=test
      - CI=true
    networks:
      - via-network
    command: sh -c "pnpm check"

networks:
  via-network:
    driver: bridge

# Usage:
#
# Start development sandbox:
#   docker-compose up -d via-sandbox
#   docker-compose exec via-sandbox sh
#
# Or simply:
#   make claude
#
# Start secure sandbox:
#   docker-compose up -d via-sandbox-secure
#   docker-compose exec via-sandbox-secure sh
#
# Run tests:
#   docker-compose run --rm via-test
#
# Run CI checks:
#   docker-compose run --rm via-ci
#
# Start dev server:
#   docker-compose up via-dev-server
#
# Stop all:
#   docker-compose down
#
# View logs:
#   docker-compose logs -f
