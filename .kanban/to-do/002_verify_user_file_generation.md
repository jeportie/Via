# 002 - Verify and Improve User File Generation

## ğŸ“‹ Description

Verify that the CLI properly generates schema files and registry in the **user's project** (not inside Via's package). Ensure the generation workflow creates files in the correct location with proper structure.

Current behavior needs verification:

- Does `npx via` create files in user's `src/` folder?
- Are paths relative to user's project root?
- Do generated files have proper imports?
- Is the registry created/updated correctly?

If generation doesn't work in user projects, fix the CLI to:

1. Resolve paths relative to `process.cwd()` (user's project)
2. Create `src/schema/` directory if it doesn't exist
3. Create `src/apiRegistry.ts` if it doesn't exist
4. Add helpful comments to generated files

## ğŸ¯ Acceptance Criteria

- [ ] CLI runs from `node_modules/.bin/via` in a user project
- [ ] Schema files are created in user's `src/schema/` directory
- [ ] Registry is created/updated in user's `src/apiRegistry.ts`
- [ ] Generated files have auto-generated headers with metadata
- [ ] Imports use correct relative paths
- [ ] Works in both existing and new projects
- [ ] Handles case where `src/` directory doesn't exist
- [ ] Registry accumulates multiple APIs (doesn't overwrite)

## ğŸ§ª How to Test

### Human Testing

1. Create a fresh test project:

   ```bash
   mkdir test-via-project
   cd test-via-project
   npm init -y
   npm install @jeportie/via
   ```

2. Run Via CLI:

   ```bash
   npx via
   ```

3. Select OpenAPI mode and enter:
   - URL: `https://petstore3.swagger.io/api/v3/openapi.json`
   - Base URL: `https://petstore3.swagger.io/api/v3`
   - Schema name: `petstoreSchema`

4. Verify files created:

   ```bash
   ls -la src/schema/petstoreSchema.ts
   ls -la src/apiRegistry.ts
   ```

5. Check file contents have proper structure

6. Run again with different API to test accumulation

### AI Testing

```bash
# Create test project
mkdir -p /tmp/via-test && cd /tmp/via-test
npm init -y
npm install /path/to/via/package

# Run CLI (automated)
echo "openapi
https://petstore3.swagger.io/api/v3/openapi.json
https://petstore3.swagger.io/api/v3
petstoreSchema" | npx via

# Verify files exist
test -f src/schema/petstoreSchema.ts && echo "âœ“ Schema created"
test -f src/apiRegistry.ts && echo "âœ“ Registry created"

# Check imports
grep -q "import.*petstoreSchema" src/apiRegistry.ts && echo "âœ“ Import correct"
```

## âœ… When to Validate

Complete when:

1. Fresh project test succeeds (files created in user's `src/`)
2. Generated files have proper structure and imports
3. Multiple API generation accumulates correctly
4. Works with both existing and non-existing `src/` folders

## ğŸ› ï¸ How to Implement

### Implementation Approach

The CLI needs to:

1. Run from user's project context (`process.cwd()`)
2. Create directories if they don't exist
3. Generate files with absolute paths from user's root
4. Add helpful headers to generated files

Key issue to check: Does `openapi-typescript` output to the right location?

### Difficulty

**Medium** - Requires testing in external projects and handling file system operations

### Key Files Involved

- `src/cli/generate.ts` - Main generation logic
  - Fix: Use `process.cwd()` for base path
  - Fix: Create directories with `fs.mkdirSync()`
  - Add: File headers with metadata

- `src/cli/registry.ts` - Registry creation
  - Fix: Resolve paths relative to user's project
  - Add: Auto-generated header

- `src/cli/updateRegistry.ts` - Registry updates
  - Verify: Doesn't overwrite existing entries
  - Add: Preserve user comments

- `package.json` - Verify `bin` field is correct:
  ```json
  "bin": {
    "via": "dist/mjs/cli/index.js"
  }
  ```

### Attention Points

1. **Path resolution**: Must use `process.cwd()` not `__dirname`

   ```typescript
   // Wrong:
   const schemaDir = path.resolve('src/schema');

   // Correct:
   const schemaDir = path.resolve(process.cwd(), 'src/schema');
   ```

2. **Directory creation**: Handle missing directories gracefully

   ```typescript
   import { mkdirSync } from 'fs';
   mkdirSync(schemaDir, { recursive: true });
   ```

3. **File headers**: Add metadata to generated files

   ```typescript
   const header = `/**
    * Auto-generated by Via CLI
    * DO NOT EDIT MANUALLY
    *
    * Generated from: ${url}
    * Base URL: ${baseUrl}
    * Generated at: ${new Date().toISOString()}
    *
    * To regenerate: npx via generate
    */\n\n`;
   ```

4. **Registry accumulation**: Don't overwrite existing entries

   ```typescript
   // Read existing registry
   // Add new entry
   // Write back preserving others
   ```

5. **Import paths**: Use `.js` extensions for ESM
   ```typescript
   import type { paths as mySchema } from './schema/mySchema.js';
   ```

### Implementation Steps

1. **Update `src/cli/generate.ts`**:

   ```typescript
   const userRoot = process.cwd();
   const schemaDir = path.resolve(userRoot, 'src/schema');
   const fileDir = path.join(schemaDir, `${schemaName}.ts`);

   // Create directory if it doesn't exist
   mkdirSync(schemaDir, { recursive: true });

   // Generate schema
   exec(`npx openapi-typescript ${url} -o ${fileDir}`, (error, stdout, stderr) => {
     if (error) {
       console.error('âŒ Generation failed:', error);
       return;
     }

     // Prepend header
     prependHeader(fileDir, { url, baseUrl, timestamp: new Date() });

     updateRegistry({ baseUrl, schemaName, schemaPath: fileDir });
   });
   ```

2. **Add header generation utility**:

   ```typescript
   function prependHeader(filePath: string, metadata: any): void {
     const content = readFileSync(filePath, 'utf-8');
     const header = `/**
    * Auto-generated by Via CLI
    * DO NOT EDIT MANUALLY
    *
    * Generated from: ${metadata.url}
    * Base URL: ${metadata.baseUrl}
    * Generated at: ${metadata.timestamp.toISOString()}
    *
    * To regenerate: npx via generate
    */\n\n`;
     writeFileSync(filePath, header + content);
   }
   ```

3. **Update `src/cli/registry.ts`**:

   ```typescript
   export function ensureRegistryExists(): void {
     const registryPath = path.resolve(process.cwd(), 'src/apiRegistry.ts');

     if (!existsSync(registryPath)) {
       const dir = path.dirname(registryPath);
       mkdirSync(dir, { recursive: true });

       const content = `/**
    * Via API Registry
    *
    * This file maps runtime base URLs to TypeScript schemas.
    * It's auto-maintained by the Via CLI.
    *
    * You can manually edit this file if needed.
    */
   export interface ApiRegistry {
     // Your APIs will be registered here
   }\n`;

       writeFileSync(registryPath, content);
     }
   }
   ```

4. **Test in isolated project**:

   ```bash
   cd /tmp
   mkdir via-test-project
   cd via-test-project
   npm init -y
   npm install /path/to/via
   npx via
   ```

5. **Verify output structure**:
   ```bash
   tree src/
   # Expected:
   # src/
   # â”œâ”€â”€ apiRegistry.ts
   # â””â”€â”€ schema/
   #     â””â”€â”€ petstoreSchema.ts
   ```

## ğŸ“š Context & References

- CLI entry point: `src/cli/index.ts`
- Current generation: `src/cli/generate.ts`
- Registry management: `src/cli/registry.ts` and `updateRegistry.ts`
- Package bin field: `package.json` line 42-44

## ğŸ”— Dependencies

Should be done before:

- 005 - Init tests (needs working generation for integration tests)
